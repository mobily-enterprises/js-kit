<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>hotplate/node_modules/hotCoreAuth/lib/auth/facebook.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/weblookalike.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">


 <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mercmobily/hotplate">View on GitHub</a>

          <h1 id="project_title">Hotplate -- documentation</h1>
          <h2 id="project_tagline">Multi-homed SaaS with NodeJs, Express, (any)DB, Dojo</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mercmobily/hotplate/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mercmobily/hotplate/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>



<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">




           <!-- 
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
            -->

        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/hotCoreAuth.html">hotCoreAuth</a></li>
            
                <li><a href="../classes/hotCoreAuth.facebook.html">hotCoreAuth.facebook</a></li>
            
                <li><a href="../classes/hotCoreClientFiles.html">hotCoreClientFiles</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/hotCoreAuth.html">hotCoreAuth</a></li>
            
                <li><a href="../modules/hotCoreClientFiles.html">hotCoreClientFiles</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: hotplate/node_modules/hotCoreAuth/lib/auth/facebook.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var dummy
  , path = require(&#x27;path&#x27;)
  , hotplate = require(&#x27;hotplate&#x27;)

  , ObjectId = require(&#x27;mongowrapper&#x27;).ObjectId
  , checkObjectId = require(&#x27;mongowrapper&#x27;).checkObjectId

  , hat = require(&#x27;hat&#x27;)

  , declare = require(&#x27;simpledeclare&#x27;)
  , passport = require(&#x27;passport&#x27;)
  , FacebookStrategy = require(&#x27;passport-facebook&#x27;).Strategy
;



var app = hotplate.app;

/**
@class hotCoreAuth.facebook
@static
*/

/**
Implements the ExpressJs routes to make the Facebook strategy work.  
It implements:

  * Manager: &#x60;/auth/manager/facebook&#x60;, &#x60;/auth/manager/facebook/callback&#x60;
  * Signin: &#x60;/auth/signin/facebook&#x60;, &#x60;/auth/manager/signin/callback&#x60;
  * Recover: &#x60;/auth/recover/facebook&#x60;, &#x60;/auth/manager/recover/callback&#x60;
  * Register: &#x60;/auth/register/facebook&#x60;, &#x60;/auth/manager/register/callback&#x60;
  * Resume: &#x60;/auth/resume/facebook&#x60;, &#x60;/auth/manager/resume/callback&#x60;

@method hotCoreAuth.facebook
*/


exports = module.exports = function( strategyConfig,  makeResponder, AuthStrategies, Users, UserStrategies, UserLogins ) {

  // Work out callbackURLBase which needs to be honoured

  var callbackURLBase = &#x27;&#x27;;
  if( typeof( hotplate.get(&#x27;hotCoreAuth&#x27;)) === &#x27;object&#x27; ){
    callbackURLBase = hotplate.get(&#x27;hotCoreAuth&#x27;).callbackURLBase;
  }

  // ***********************
  // *** MANAGER         ***
  // ***********************

  passport.use(&#x27;facebook-manager&#x27;, new FacebookStrategy({
    clientID: strategyConfig.clientID,
    clientSecret: strategyConfig.clientSecret,
    callbackURL: callbackURLBase + &quot;/auth/manager/facebook/callback&quot;,
    passReqToCallback: true,
  },

  function(req, accessToken, refreshToken, profile, done) {


    if( ! req.session.loggedIn ){
      done( null, false );
    } else {

      // The profile MUST contain an ID
      if( typeof( profile ) === &#x27;undefined&#x27; || ! profile.id ){ 
         return done( null, false, { message: &quot;Facebook didn&#x27;t return a profile ID, procedure aborted&quot; } );
      }

      // Check that &quot;facebook&quot; isn&#x27;t already there
      UserStrategies.GetQuery( { filters: { userId: req.session.userId, strategyId: &#x27;facebook&#x27; } }, function( err, res ){
        if( err ) {
          done( err, null );
        } else {
          if( res.length ){
            done( null, false, { message: &quot;User already has a Facebook login setup&quot; } );
          } else {
            
            // Check that &quot;facebook&quot; isn&#x27;t already there
            UserStrategies.GetQuery( { filters: { field1: profile.id } }, function( err, res ){
              if( err ) {
                done( err, null );
              } else {
                if( res.length ){
                  done( null, false, { message: &quot;Facebook profile already linked to another account&quot; } );
                } else {

                  UserStrategies.Post( { userId: req.session.userId, strategyId: &#x27;facebook&#x27;, field1: profile.id }, function( err, res, idProperty ){
                    if( err ) {
                      done( err, null );
                    } else {
                      Users.Get( req.session.userId, function( err, user ){
                        if( err ){
                          done( err, null );
                        } else {
                          done( null, user, profile  );
                        }
                      });
                    }
                  });

                }
              }
           });
            
          } 
        }
      });
    }
  }
  ));

  app.get(&#x27;/auth/manager/facebook&#x27;, passport.authenticate(&#x27;facebook-manager&#x27;));
  app.get(&#x27;/auth/manager/facebook/callback&#x27;, function( req, res, next) {
    passport.authenticate(&#x27;facebook-manager&#x27;,  makeResponder( req, res, next, &#x27;facebook&#x27;, &#x27;manager&#x27;)  )(req, res, next);
  });


  // ***********************
  // *** SIGN IN         ***
  // ***********************

  passport.use(&#x27;facebook-signin&#x27;, new FacebookStrategy({
    clientID: strategyConfig.clientID,
    clientSecret: strategyConfig.clientSecret,
    callbackURL: callbackURLBase + &quot;/auth/signin/facebook/callback&quot;,
    passReqToCallback: true,
  },

  function(req, accessToken, refreshToken, profile, done) {

    if( req.session.loggedIn ){
      done( null, false );
    } else {

      // The profile MUST contain an ID
      if( typeof( profile ) === &#x27;undefined&#x27; || ! profile.id ){ 
         return done( null, false, { message: &quot;Facebook didn&#x27;t return a profile ID, procedure aborted&quot; } );
      }

      UserStrategies.GetQuery( { filters: { strategyId: &#x27;facebook&#x27;, field1: profile.id } }, function( err, res, idProperty ){
        if( err ) {
          done( err, null );
        } else {

          if( res.length ){
            Users.Get( res[0].userId, function( err, user, idProperty ){
              if( err ){
                done( err, null );
              } else {
                req.session.loggedIn = true;
                req.session.userId = user[ idProperty ];
                done( null, user, profile  );
              }
            });

          } else {
            done( null, false, { message: &quot;Your Facebook user is not registered&quot; } );
          }
        }
      });

    }

    // done( null, false );
  }
  ));

  app.get(&#x27;/auth/signin/facebook&#x27;, passport.authenticate(&#x27;facebook-signin&#x27;));
  app.get(&#x27;/auth/signin/facebook/callback&#x27;, function( req, res, next) {
    passport.authenticate(&#x27;facebook-signin&#x27;,  makeResponder( req, res, next, &#x27;facebook&#x27;, &#x27;signin&#x27;)  )(req, res, next);
  });

  // ***********************
  // *** RECOVER         ***
  // ***********************

  passport.use(&#x27;facebook-recover&#x27;, new FacebookStrategy({
    clientID: strategyConfig.clientID,
    clientSecret: strategyConfig.clientSecret,
    callbackURL: callbackURLBase + &quot;/auth/recover/facebook/callback&quot;,
    passReqToCallback: true,
  },

  function(req, accessToken, refreshToken, profile, done) {

    if( req.session.loggedIn ){
      done( null, false );
    } else {

      // The profile MUST contain an ID
      if( typeof( profile ) === &#x27;undefined&#x27; || ! profile.id ){ 
         return done( null, false, { message: &quot;Facebook didn&#x27;t return a profile ID, procedure aborted&quot; } );
      }

      UserStrategies.GetQuery( { filters: { strategyId: &#x27;facebook&#x27;, field1: profile.id } }, function( err, res, idProperty ){
        if( err ) {
          done( err, null );
        } else {

          if( res.length ){
            Users.Get( res[0].userId, function( err, user, idProperty ){
              if( err ){
                done( err, null );
              } else {
                // RECOVER PROCEDURE
                
                // Create the recoveryToken
                user.recoverToken = hat();
                user.recoverTokenCreated = new Date();

                // Place the token in the user&#x27;s record
                Users.Put( user._id, user, function( err, newUser ){
                  if( err ){
                    done( err, null );
                  } else {
                    done( null, false, { message: &quot;Recovery procedure initiated&quot; }  );
                  }
                } );

              }
            });
          } else {
            done( null, false, { message: &quot;Your Facebook user is not registered&quot; } );
          }
        }
      });


    }

  }
  ));

  app.get(&#x27;/auth/recover/facebook&#x27;, passport.authenticate(&#x27;facebook-recover&#x27;));
  app.get(&#x27;/auth/recover/facebook/callback&#x27;, function( req, res, next) {
    passport.authenticate(&#x27;facebook-recover&#x27;,  makeResponder( req, res, next, &#x27;facebook&#x27;, &#x27;recover&#x27;)  )(req, res, next);
  });


  // ***********************
  // *** REGISTER        ***
  // ***********************

  passport.use(&#x27;facebook-register&#x27;, new FacebookStrategy({
    clientID: strategyConfig.clientID,
    clientSecret: strategyConfig.clientSecret,
    callbackURL: callbackURLBase + &quot;/auth/register/facebook/callback&quot;,
    passReqToCallback: true,
  },

  function(req, accessToken, refreshToken, profile, done) {

    if( req.session.loggedIn ){
      done( null, false );
    } else {

      // The profile MUST contain an ID
      if( typeof( profile ) === &#x27;undefined&#x27; || ! profile.id ){ 
         return done( null, false, { message: &quot;Facebook didn&#x27;t return a profile ID, procedure aborted&quot; } );
      }

      // Check that &quot;facebook&quot; isn&#x27;t already there
      UserStrategies.GetQuery( { filters: { strategyId: &#x27;facebook&#x27;, field1: profile.id } }, function( err, res, idProperty ){
        if( err ) {
          done( err, null );
        } else {
          if( res.length ){
            done( null, false, { message: &quot;Facebook profile already registered&quot; } );
          } else {
            Users.Post( { }, function( err, user, idProperty ){

              if( err ){
                done( err, null );
              } else {

                UserStrategies.Post( { userId: user[ idProperty ], strategyId: &#x27;facebook&#x27;, field1: profile.id }, function( err, res, idProperty ){
                  if( err ) {
                    done( err, null );
                  } else {

                    // User just registered: make her &quot;logged in&quot;
                    req.session.loggedIn = true;
                    req.session.userId = res.userId;

                    done( null, user, profile );
                  }

                });
              }

            });

          } 
        }
      });
    }

  }
  ));

  app.get(&#x27;/auth/register/facebook&#x27;, passport.authenticate(&#x27;facebook-register&#x27;));
  app.get(&#x27;/auth/register/facebook/callback&#x27;, function( req, res, next) {
    passport.authenticate(&#x27;facebook-register&#x27;,  makeResponder( req, res, next, &#x27;facebook&#x27;, &#x27;register&#x27;)  )(req, res, next);
  });



  // ***********************
  // *** RESUME          ***
  // ***********************

  passport.use(&#x27;facebook-resume&#x27;, new FacebookStrategy({
    clientID: strategyConfig.clientID,
    clientSecret: strategyConfig.clientSecret,
    callbackURL: callbackURLBase + &quot;/auth/resume/facebook/callback&quot;,
    passReqToCallback: true,
  },

  function(req, accessToken, refreshToken, profile, done) {

    if( req.session.loggedIn ){
      done( null, false );
    } else {

      // The profile MUST contain an ID
      if( typeof( profile ) === &#x27;undefined&#x27; || ! profile.id ){ 
         return done( null, false, { message: &quot;Facebook didn&#x27;t return a profile ID, procedure aborted&quot; } );
      }

      UserStrategies.GetQuery( { filters: { strategyId: &#x27;facebook&#x27;, field1: profile.id } }, function( err, res, idProperty ){
        if( err ) {
          done( err, null );
        } else {

          if( res.length ){
            Users.Get( res[0].userId, function( err, user, idProperty ){
              if( err ){
                done( err, null );
              } else {
                req.session.loggedIn = true;
                req.session.userId = user[ idProperty ];
                profile.message = &quot;Logged back in!&quot;;

                done( null, user, profile  );
              }
            });

          } else {
            done( null, false, { message: &quot;Your Facebook user is not registered&quot; } );
          }
        }
      });

    }

    // done( null, false );
  }
  ));

  app.get(&#x27;/auth/resume/facebook&#x27;, passport.authenticate(&#x27;facebook-resume&#x27;));
  app.get(&#x27;/auth/resume/facebook/callback&#x27;, function( req, res, next) {
    passport.authenticate(&#x27;facebook-resume&#x27;,  makeResponder( req, res, next, &#x27;facebook&#x27;, &#x27;resume&#x27;)  )(req, res, next);
  });


} 

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
