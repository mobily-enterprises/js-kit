"use strict";

var dummy
  , hotplate =  require('hotplate')
  , path = require('path')
;


// Some defaults to get things going
//  * needs to be asyncronous, AND
//  * needs to have the package "hotplate" set
//  * needs to have a "local" blank.html file configured via dojoBlankHtmlUrl
hotplate.config.set( 'hotDojoAdd.dojoConfig', {
  packages: [
    {
      name: 'hotplate',
      location: hotplate.config.get( 'hotplate.moduleFilesPrefix' ),
    },
  ],
  dojoBlankHtmlUrl: path.join( hotplate.config.get( 'hotplate.moduleFilesPrefix' ), 'hotDojo', 'blank.html' ),
  async: 1,
});

// By default, take Dojo from the CDN. It will always work. Developers will set
// a direct path for Dojo in their local machine so that debugging is easier
hotplate.config.set( 'hotDojoAdd.dojoUrl', "//ajax.googleapis.com/ajax/libs/dojo/1.8.5/dojo/dojo.js.uncompressed.js" );
hotplate.config.set( 'hotDojoAdd.cssUrl',  "//ajax.googleapis.com/ajax/libs/dojo/1.8.5/dijit/themes/claro/claro.css" );
hotplate.config.set( 'hotDojoAdd.bodyClass',  "claro" );


hotplate.hotEvents.on( 'pageElements', 'hotDojoAdd', hotplate.cachable( function( done ){

  var headLines, dojoConfigAssign;

  hotplate.hotEvents.emit( 'enrichDojoConf', hotplate.config.get( 'hotDojoAdd.dojoConfig'), function( err, results ){

    if(err){
      done( err );
    } else {

      // Make up the string to add to the page
      dojoConfigAssign = "<script>dojoConfig = " + JSON.stringify( hotplate.config.get( 'hotDojoAdd.dojoConfig') ) + "</script>"; // MAYBE ADD replace(/\//g,'\\/').

      headLines = [
        dojoConfigAssign,
        '<link type="text/css" rel="stylesheet" href="' + hotplate.config.get( 'hotDojoAdd.cssUrl' ) + '" media="screen" />',
        '<script src="' + hotplate.config.get( 'hotDojoAdd.dojoUrl' ) + '"></script>',
      ];

      done( null, { headLines: headLines } );
    }
  });

}));

hotplate.hotEvents.on( 'pageElementsPerPage', 'hotDojoAdd', function( req, pageName, done ){

  hotplate.hotEvents.emit( 'dojoModulesPerPage', req, pageName, function( err, dojoModules ){
    if( err ){
      done( err );
    } else {

      var result = '';

      result += '<script>\n';
      result += '  // Modules marked as to be loaded by hotplate\n';
      result += '  require(["dojo/topic", "dojo/dom-class", "dojo/_base/window", ';

      // Make up the list of modules as a comma separated string, depending on what returned
      var listAsArray = [];
      dojoModules.forEach( function( moduleInfo ){
        moduleInfo.result.forEach( function( moduleResult ){
          listAsArray.push( '"' + path.join( 'hotplate', moduleInfo.module, moduleResult) + '"');
        });
      });
      result += listAsArray.join() + ', "dojo/domReady!"], function(topic, domClass, win ){\n';

      result += '\n';
      result += '    // This topic will tell hotplate modules that everything has been loaded up\n';
      
      result += '    domClass.add( win.body(), "claro" );\n';
      result += '    topic.publish( "hotplateModulesLoaded" );\n';
      result += '  })\n';
      result += '</script>\n';

      done( null, { headLines: [ result ] } );
    }
  });
});


// Simply activate path to client files
hotplate.hotEvents.on( 'clientPath', 'hotDojo', function( done ){
  done( null, path.join(__dirname, '../client') );
})

